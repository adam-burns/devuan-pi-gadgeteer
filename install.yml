---
- name: Install some packages
  hosts: all
  tasks:

# Wait until host is ready
   - name: Wait for host {{inventory_hostname}} connection
     wait_for_connection:
    
# Install bridge-utils for bridging both usb ethernet interfaces
   - name: install bridge-utils
     package:
       name: bridge-utils
       state: present

# Install avahi-autoipd for zeroconf networking (ipv4ll method) on usb[0,1]
   - name: install avahi-autoipd
     package:
       name: avahi-autoipd
       state: present

# Install dnsmasq for dhcp over br0 interface
   - name: install dnsmasq
     package:
       name: dnsmasq
       state: present

# TODO consider dynamic network assignment for each host
   - name: configure dnsmasq
     ansible.builtin.copy:
       src: etc/dnsmasq.d/usb.conf
       dest: /etc/dnsmasq.d/usb.conf

# DEBUG Clone Reflow repo
   - name: Clone devuan-pi-setup repository
     git:
       repo: https://github.com/adam-burns/devuan-pi-setup
       dest: devuan-pi-setup
       version: master
       clone: yes
       update: yes

# Add loading overlay module dwc2 to cmdline.txt
   - name: "Add loading overlay module dwc2 to cmdline.txt"
     become: yes
     become_user: root
     replace: 
       path: /boot/cmdline.txt
       regexp: '^(.*)rootwait$'
       replace: '\1 rootwait modules-load=dwc2'
       backup: no
     register: cmdline_updated

   - name: Check if dtoverlay=dwc2 is present
     become: yes
     become_user: root
     lineinfile:
       state: absent
       path: "/boot/config.txt"
       regexp: "^dtoverlay=dwc2"
     check_mode: true
     changed_when: false # This just makes things look prettier in the logs
     register: check
   
   - name: Add dtoverlay=dwc2 if not present
     lineinfile:
       state: present
       path: "/boot/config.txt"
       line: "dtoverlay=dwc2"
     when: check.found == 0

   - name: Check if libcomposite module is configured in /etc/modules
     become: yes
     become_user: root
     lineinfile:
       state: absent
       path: "/etc/modules"
       regexp: "^libcomposite"
     check_mode: true
     changed_when: false # This just makes things look prettier in the logs
     register: check
   
   - name: Add libcomposite if not present
     lineinfile:
       state: present
       path: "/etc/modules"
       line: "libcomposite"
     when: check.found == 0

   - name: configure usb0 network interface
     ansible.builtin.copy:
       src: etc/network/interfaces.d/usb0.conf
       dest: /etc/network/interfaces.d/usb0.conf

   - name: configure usb1 network interface
     ansible.builtin.copy:
       src: etc/network/interfaces.d/usb1.conf
       dest: /etc/network/interfaces.d/usb1.conf

   - name: configure br0 network interface
     ansible.builtin.copy:
       src: etc/network/interfaces.d/br0.conf
       dest: /etc/network/interfaces.d/br0.conf

   - name: configure network forwarding
     ansible.builtin.copy:
       src: etc/sysctl.d/30-forwarding.conf
       dest: /etc/sysctl.d/30-forwarding.conf

   - name: Create /var/lib/dnsmasq if it does not exist
     ansible.builtin.file:
       path: /var/lib/dnsmasq
       state: directory
       mode: '0755'

   - name: Create /etc/boot.d if it does not exist
     ansible.builtin.file:
       path: /etc/boot.d
       state: directory
       mode: '0755'

   - name:  network masquerading set at boot
     ansible.builtin.copy:
       src: etc/boot.d/masquerade.nft
       dest: /etc/boot.d/masquerade
       mode: '0755'

   - name: usb_gadget set at boot
     ansible.builtin.copy:
       src: etc/boot.d/usb_gadget.sh
       dest: /etc/boot.d/usb_gadget
       mode: '0755'


   - name: install usb_gadget
     ansible.builtin.copy:
       src: usb_gadget
       dest: /usr/local/bin/usb_gadget
       mode: '0755'

       #   - name: restart network-manager
       #     sysvinit:
       #       name: network-manager
       #       state: restarted

   - name: reboot if necessary
     ansible.builtin.reboot:
       reboot_timeout: 3600
     when: cmdline_updated.changed

       ##   
       #   - name: enable dnsmasq
       #     sysvinit:
       #       name: dnsmasq
       #       state: started
       #       enabled: yes
       #
       #   - name: execute nft masquerade script
       #     become: yes
       #     become_user: root
       #     command: /etc/boot.d/masquerade
       #
       #   - name: execute usb_gadget
       #     become: yes
       #     become_user: root
       #     command: /usr/local/bin/usb_gadget

